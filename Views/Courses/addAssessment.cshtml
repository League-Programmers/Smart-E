@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.AspNetCore.Identity
@model Smart_E.Models.Courses.QuizViewModel

@{
    ViewData["Title"] = "Create Assessment";
    Layout = "_Layout";
    var isAdmin = await _userManager.GetUserAsync(User);
}
@inject IViewLocalizer _localizer
@inject UserManager<ApplicationUser> _userManager
<!DOCTYPE html>
<html dir="ltr" lang="en">

  <head>
    <link href="~/assets/libs/magnific-popup/dist/magnific-popup.css" rel="stylesheet">
    <link href="~/assets/libs/datatables.net-bs4/css/dataTables.bootstrap4.css" rel="stylesheet">
    <link href="~/assets/libs/footable/css/footable.core.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="~/assets/libs/select2/dist/css/select2.min.css">
    <link href="~/assets/libs/sweetalert2/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.4.0/min/dropzone.min.css" />
    <link rel="stylesheet" type="text/css" href="~/assets/libs/bootstrap-switch/dist/css/bootstrap3/bootstrap-switch.min.css">
  </head>

<body>

<div class="preloader">
    <div class="lds-ripple">
        <div class="lds-pos"></div>
        <div class="lds-pos"></div>
    </div>
</div>

<div class="page-breadcrumb">
    <div class="row">
        <div class="col-5 align-self-center">
            <h3 class="page-title">@_localizer["Create Assessment"]</h3>
            <div class="d-flex align-items-center">
            </div>
        </div>
    </div>
</div>

 <div class="container-fluid"  style="background-color: #2f3d54; color: white">
    <div class="row">
        <div class="col-12">
            <button type="button"@(await _userManager.IsInRoleAsync(isAdmin, "Teacher") ? "" : "hidden=\"hidden\"") onclick="javascript:showAddAssessModal();" style="margin-left: 5px;" class="btn btn-sm btn-success float-lg-right"><i class="fas fa-plus"><span>Add Assessment</span></i></button>
        </div>
    </div>
    <div class="row">
    <div class="col-md-4">
         <div class="card-body">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
          <form asp-action="addAssessment" method="post">
            <div class="form-group">
                     <label for="cbAssessment">Choose Assessment Name</label>
                     <select  id="cbAssessment" class="form-control" style="width: 100%;  height: 36px;">
                     <option value="0">Select Assessment</option>
                     @foreach (var t in ViewBag.Assessment)
                     {
                        <option value="@t.AssessmentId">@t.AssessmentName</option>
                     }
                     </select>
            </div>
           <div class="form-group">
            <label asp-for="Questions">Type in question</label>
            <input asp-for="Questions" id="txtQuestions" class="form-control" />
           </div>

           <div class="form-group">
           <label asp-for="OptionName">Option</label>
           <input asp-for="OptionName" id="txtOptionName" class="form-control" />
           </div>
           <div class="form-group">
           <input id="btnAddOption" class="btn btn-dark" name="Option" value="Add Option"/>
          
           </div>
          </form>   
         </div>
    </div>
      <table id="tblOption" class="table table-condensed" style=" width:100%">
      </table>

      <div class="container">
      <input type="button" id="btnSave" class="btn btn-primary" name="Save" value="Save"/>
      </div>
    </div>
</div>

<div id="addAssess" class="modal fade" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Create Assessment</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                </div>
                <div class="modal-body">
                 <form>
                     <div class="form-group">
                     <label for="cbCourseId"  class="control-label">Choose Subject Name</label>
                     <select class="select2 form-control"  id="cbCourseId" style="width: 100%;  height: 36px;">
                     <option value="0">Select Subject</option>
                     @foreach (var t in ViewBag.Course)
                     {
                       <option value="@t.CourseId">@t.CourseName</option>
                     }
                     </select>
                     </div>
                     <div class="form-group">
                     <label for="txtAssessmentName" class="control-label">Assessment Name</label>
                     <input type="text"  class="form-control" id="txtAssessmentName" style="width: 100%" />
                     </div>
                     <div class="form-group">
                     <label for="cbtypeAssesId" class="control-label">Choose Type Of Assessment </label>
                     <select class="select2 form-control"  id="cbtypeAssesId" style="width: 100%;  height: 36px;">
                     <option value="0">Select Type</option>
                     @foreach (var t in ViewBag.Type)
                     {
                       <option value="@t.typeAssesId">@t.typeAssesName</option>
                     }
                     </select>
                     </div>
                     <div class="form-group">
                     <label for="txtTotalMark" class="control-label">Total mark</label>
                     <input type="text"  class="form-control"  id="txtTotalMark" style="width: 100%" />
                     </div>
                     <div class="form-group">
                     <label for="txtPercentage"  class="control-label">Percentage</label>
                     <input  type="text"  class="form-control" id="txtPercentage" style="width: 100%"/>
                     </div>
                     <div class="form-group">
                     <label for="txtCreated"  class="control-label">Date</label>
                     <input type="text"  class="form-control" id="txtCreated" style="width: 100%"/>
                     </div>

                 </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-info waves-effect" data-dismiss="modal">Cancel</button>
                    <button type="button" id="BtnCreateServiceNote" onclick="javascript: createassessment();" class="btn btn-outline-danger waves-effect waves-light">Create</button>
                </div>
            </div>
        </div>
</div>

</body>
<div>
    <script src="~/assets/libs/moment/moment.js"></script>
    <script src="~/assets/libs/bootstrap-material-datetimepicker/js/bootstrap-material-datetimepicker-custom.js"></script>
    <script src="~/assets/extra-libs/DataTables/datatables.min.js"></script>
    <script src="~/dist/js/pages/datatable/datatable-basic.init.js"></script>
    <script src="~/assets/libs/select2/dist/js/select2.full.min.js"></script>
    <script src="~/assets/libs/select2/dist/js/select2.min.js"></script>
    <script src="~/dist/js/pages/forms/select2/select2.init.js"></script>
    <script src="~/assets/libs/sweetalert2/dist/sweetalert2.all.min.js"></script>
    <script src="~/assets/libs/sweetalert2/sweet-alert.init.js"></script>
    <script src="~/assets/libs/moment/moment.js"></script>
    <script src="~/assets/libs/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
</div>
<script>
 function showAddAssessModal() {
    $('#addAssess').modal('show');
 }

    function createassessment() {
        var model = {
            courseName: $('#cbCourseId').val(),
            assessmentName: $('#txtAssessmentName').val(),
            type: $('#cbtypeAssesId').val(),
            totalMark: $('#txtTotalMark').val(),
            percentage: $('#txtPercentage').val(),
            created: $('#txtCreated').val()
        }
        $.ajax({
            url: '@Url.Action("CreateAssessment", "Courses")',
            type: 'POST',
            dataType: 'json',
            data: JSON.stringify(model),
            contentType: "application/json; charset=utf-8",
            success: function(result) {

                $('#addAssess').modal('hide');
                  loadassessment();
            },
            error: function(jqXHR, exception) {
                swal({
                    title: "ERROR STATUS " + jqXHR.status,
                    text: "Error Message: " + jqXHR.responseText,
                    type: "error",
                    showCancelButton: false,
                    confirmButtonText: "OK"
                });
            }
        });
    }
    
    $(document).ready(function() {
        loadassessment();
    });
    
    $(document).ready(function() {
    $("#btnAddOption").click(function() {
        AddOptionIntoList();
    });

    $("#btnSave").click(function() {
    SaveQuestionAndOption();
});
});

function SaveQuestionAndOption() {
    if ($("#tblOption tr").length !== 4) {
        
        alert("Option shoul not be more or less than 4.");

        return false;
    }

    var answerText = "";
    var answerValid = undefined;
    $.each($("#tblOption tr"),
        function() {
             answerText = $(this).find("td:eq(0) input[type=radio]:checked").val();
             
          if (answerText !== undefined) {
              answerValid = answerText;
          }
        }
    );

    
    if (answerText === undefined) {
        alert("Select the answer.");
        return false;
    }

    var ListOfOptions = [];
    var answerTextData = "";
    var QuestionOption = "";
    $.each($("#tblOption tr"),
        function() {
             answerText = $(this).find("td:eq(0) input[type=radio]:checked").val();
             
          if (answerText !== undefined) {
              answerTextData = answerText;
          }
            ListOfOptions.push(answerText);
        }
    );
    QuestionOption.Options = ListOfOptions;
    QuestionOption.AnswerText = answerTextData;
    QuestionOption.QuestionName = $("#txtQuestions").val();
    QuestionOption.CourseId = $("#cbSubject").val();

    $.ajax({
        async: true,
        type:'POST',
        dataType: 'JSON',
        data: JSON.stringify(QuestionOption),
        url: '/Courses/addAssessment',
        contentType: 'application.json; charset=utf-8',
        success: function(data) {
            if (data.success === true) {
                alert(data.message);
                $("#txtQuestions").val("");
                $("#txtQuestions").focus();

                 $("#txtOptionName").val("");
                $("#tblOption tr").remove();
                $("#ddAssessment").val(1);
                
         
            }
            else {
                alert(data.message)
            }
        },
        error: function() {
            alert('There some problem processing your request, try again after some time.');
        }
    })
}
function AddOptionIntoList() {
    //txtOptionName
    //tblOption

    if ($("#txtQuestions").val() === '') {
         $("#txtQuestions").focus();
        alert("Question should not be empty.");
       
        return false;
    }
    if ($("#txtOptionName").val() === '') {
         $("#txtOptionName").focus();
        alert("Option should not be empty.");
       
        return false;
    }
    if ($("#tblOption tr").length === 4) {
         $("#txtOptionName").focus();
          $("#txtOptionName").val('');
        alert("Option shoul not be more than 4.");

        return false;
    }

    var isSuccess = false;
    $.each($("#tblOption tr"),
        function() {
            var listedvalue = $(this).find("td:eq(0) input[type=radio]").val();
            if (listedvalue === $("#txtOptionName").val()) {
                 $("#txtOptionName").focus();
          $("#txtOptionName").val('');
                alert("Its already listed");
                isSuccess = true;
            }
        }
    );

    if (isSuccess === true) {
        return false;
    }

    var OptionName = $("#txtOptionName").val();
    var rowAdded = "<tr><td> <input type='radio' value=" + OptionName + " name='OptionName'/>" + OptionName + "</td></tr>";

    $("#tblOption").append(rowAdded);
    $("#txtOptionName").focus();
    $("#txtOptionName").val('');
   
}

</script>

